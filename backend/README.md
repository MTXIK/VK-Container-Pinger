# Сервис Backend

Сервис Backend обеспечивает RESTful API для работы с данными пингов контейнеров. Он принимает запросы на получение, добавление и удаление записей о пинге, взаимодействует с базой данных PostgreSQL для хранения информации и использует Redis для кэширования. Кроме того, сервис запускает Kafka consumer для приёма сообщений с результатами пингов и сохранения их в базу.

## Переменные окружения

- **DB_HOST** – адрес сервера базы данных (например, `postgres`).
- **DB_USER** – имя пользователя базы данных (например, `postgres`).
- **DB_PASSWORD** – пароль пользователя базы данных (например, `mypassword`).
- **DB_NAME** – имя базы данных (например, `mydb`).
- **KAFKA_BROKER** – адрес Kafka-брокера (например, `kafka:9092`).
- **REDIS_ADDR** – адрес Redis-сервера (например, `redis:6379`).
- **PORT** – порт, на котором работает сервис (например, `8080`).

## Основные функции

- **RESTful API:**  
  - `GET /api/pings` — возвращает список записей о пингах.
  - `POST /api/ping` — добавляет (или обновляет) запись о пинге.
  - `DELETE /api/pings/old` — удаляет устаревшие записи.

- **Kafka Consumer:**  
  Сервис слушает Kafka-топик `ping-results` и сохраняет поступающие сообщения в базу данных, обновляя кэш в Redis.

- **Кэширование:**  
  Redis используется для кэширования ответов API, что позволяет уменьшить нагрузку на базу данных.

- **Очистка данных:**  
  Периодически (например, раз в 24 часа) производится удаление устаревших записей из базы.
  

## API

### GET `/api/pings`

**Описание:**  
Возвращает список записей о пингах. Записи кэшируются на 10 секунд для ускорения ответа.

**Параметры запроса:**  
- `limit` (необязательный): количество записей для выборки. По умолчанию — 100.

**Пример запроса:**

```bash
curl -X GET "http://localhost:8080/api/pings?limit=50"
```

**Пример ответа:**

```json
[
  {
    "id": 1,
    "ip_address": "192.168.1.1",
    "container_name": "container-1",
    "ping_time": 12.34,
    "last_success": "2025-02-06T12:00:00Z"
  },
  {
    "id": 2,
    "ip_address": "192.168.1.2",
    "container_name": "container-2",
    "ping_time": 56.78,
    "last_success": "2025-02-06T12:05:00Z"
  }
]
```

---

### POST `/api/ping`

**Описание:**  
Добавляет (или обновляет) запись о пинге. После успешного добавления кэш с записями (`pings_cache`) очищается.

**Тело запроса:**  
Отправляем JSON с данными пинга, соответствующими структуре `PingResult`:

```json
{
  "ip_address": "192.168.1.100",
  "container_name": "my-container",
  "ping_time": 23.45,
  "last_success": "2025-02-06T14:30:00Z"
}
```

> **Примечание:**  
> Поле `id` является опциональным и используется, если необходимо обновить существующую запись.

**Пример запроса:**

```bash
curl -X POST "http://localhost:8080/api/ping" \
     -H "Content-Type: application/json" \
     -d '{
           "ip_address": "192.168.1.100",
           "container_name": "my-container",
           "ping_time": 23.45,
           "last_success": "2025-02-06T14:30:00Z"
         }'
```

**Ответ:**  
В случае успеха сервер вернёт статус `201 Created` без тела ответа.

---

### DELETE `/api/pings/old`

**Описание:**  
Удаляет устаревшие записи. Для удаления необходимо передать параметр `before` в формате RFC3339, который определяет временную границу (удаляются записи с датой `last_success` ранее указанной).

**Параметры запроса:**  
- `before` (обязательный): метка времени в формате RFC3339.  
  Пример: `2025-02-06T12:00:00Z`

**Пример запроса:**

```bash
curl -X DELETE "http://localhost:8080/api/pings/old?before=2025-02-06T12:00:00Z"
```

**Пример ответа:**

```json
{
  "message": "Старые записи успешно удалены"
}
```

## Зависимости

- **PostgreSQL** – хранение данных.
- **Redis** – кэширование.
- **Kafka** – обмен сообщениями.
- **Gin** – фреймворк для создания API.
